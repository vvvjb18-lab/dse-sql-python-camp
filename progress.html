<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç¿’é€²åº¦ - DSE SQL è¨“ç·´ç‡Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }
        .gradient-text {
            background: linear-gradient(135deg, #22c55e, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .glass-card {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 1rem;
            border: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(18px);
        }
        .stat-label {
            @apply text-xs text-slate-400 mb-1;
        }
        .stat-value {
            @apply text-2xl font-semibold;
        }
        /* Markdown å…§å®¹æ¨£å¼ */
        #ai-analysis-content {
            line-height: 1.7;
        }
        #ai-analysis-content h1,
        #ai-analysis-content h2,
        #ai-analysis-content h3 {
            color: #f1f5f9;
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.75em;
        }
        #ai-analysis-content h1 {
            font-size: 1.5em;
            border-bottom: 1px solid rgba(148, 163, 184, 0.3);
            padding-bottom: 0.5em;
        }
        #ai-analysis-content h2 {
            font-size: 1.25em;
        }
        #ai-analysis-content h3 {
            font-size: 1.1em;
        }
        #ai-analysis-content p {
            margin-bottom: 1em;
            color: #e2e8f0;
        }
        #ai-analysis-content ul,
        #ai-analysis-content ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }
        #ai-analysis-content li {
            margin-bottom: 0.5em;
            color: #e2e8f0;
        }
        #ai-analysis-content code {
            background: rgba(15, 23, 42, 0.8);
            padding: 0.2em 0.4em;
            border-radius: 0.25rem;
            font-size: 0.9em;
            color: #7dd3fc;
        }
        #ai-analysis-content pre {
            background: rgba(15, 23, 42, 0.8);
            padding: 1em;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1em;
        }
        #ai-analysis-content pre code {
            background: transparent;
            padding: 0;
            color: #e2e8f0;
        }
        #ai-analysis-content blockquote {
            border-left: 3px solid #3b82f6;
            padding-left: 1em;
            margin-left: 0;
            color: #cbd5e1;
            font-style: italic;
        }
        #ai-analysis-content strong {
            color: #f1f5f9;
            font-weight: 600;
        }
        #ai-analysis-content em {
            color: #cbd5e1;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
    <!-- å°èˆªæ¬„ -->
    <nav class="bg-slate-950/80 border-b border-slate-800 sticky top-0 z-40 backdrop-blur">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-emerald-500 to-sky-500 flex items-center justify-center shadow-lg shadow-emerald-500/40">
                        <span class="text-white font-bold text-sm">PG</span>
                    </div>
                    <div>
                        <div class="text-sm font-semibold text-slate-100">DSE SQL è¨“ç·´ç‡Ÿ</div>
                        <div class="text-xs text-slate-400">å­¸ç¿’é€²åº¦ Â· æ•¸æ“šé¢æ¿</div>
                    </div>
                </div>
                <div class="hidden md:flex items-center space-x-6 text-sm">
                    <a href="index.html" class="text-slate-300 hover:text-emerald-400">è¨“ç·´å¹³å°</a>
                    <a href="practice.html" class="text-slate-300 hover:text-emerald-400">é¡Œåº«ç·´ç¿’</a>
                    <a href="all-practice.html" class="text-slate-300 hover:text-emerald-400">ç¶œåˆç·´ç¿’</a>
                    <a href="interactive.html" class="text-slate-300 hover:text-emerald-400">äº’å‹•ç·´ç¿’</a>
                    <a href="guide.html" class="text-slate-300 hover:text-emerald-400">å­¸ç¿’æŒ‡å—</a>
                    <a href="user-system.html" class="text-slate-300 hover:text-emerald-400">ç”¨æˆ¶ä¸­å¿ƒ</a>
                    <span class="px-3 py-1 rounded-full bg-emerald-500/15 text-emerald-300 text-xs border border-emerald-500/40">ç›®å‰ï¼šå­¸ç¿’é€²åº¦</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹ -->
    <main class="py-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
            <!-- æ¨™é¡Œå€ -->
            <section class="glass-card p-6 md:p-8">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                    <div>
                        <h1 class="text-3xl md:text-4xl font-bold gradient-text mb-2">
                            å€‹äººå­¸ç¿’é€²åº¦ç¸½è¦½
                        </h1>
                        <p class="text-sm md:text-base text-slate-300 max-w-2xl">
                            é€™è£¡æœƒé¡¯ç¤ºä½ åœ¨ DSE SQL è¨“ç·´ç‡Ÿä¸­çš„å®Œæˆé¡Œç›®ã€æ­£ç¢ºç‡ã€ç´¯è¨ˆå­¸ç¿’æ™‚æ•¸èˆ‡ç¸½ç©åˆ†ã€‚
                            ç™»å…¥å¾Œæ•¸æ“šæœƒè‡ªå‹•å¾ SQLite è³‡æ–™åº«è¼‰å…¥ã€‚
            </p>
        </div>
                    <div class="space-y-2 text-xs text-slate-400 md:text-right">
                        <div>æç¤ºï¼šå¦‚æ•¸æ“šæœªæ›´æ–°ï¼Œå¯æŒ‰ä¸‹ã€Œé‡æ–°æ•´ç†ã€æŒ‰éˆ•ã€‚</div>
                        <div id="progress-user-info" class="text-slate-300">å°šæœªç™»å…¥</div>
                    </div>
                </div>
            </section>

            <!-- æœªç™»å…¥æç¤º -->
            <section id="progress-not-logged" class="glass-card p-6 flex items-center space-x-4 hidden">
                <div class="w-14 h-14 rounded-2xl bg-slate-900 flex items-center justify-center border border-slate-700">
                    <span class="text-3xl">ğŸ”</span>
                            </div>
                <div>
                    <h2 class="text-lg font-semibold text-slate-50 mb-1">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹å­¸ç¿’é€²åº¦</h2>
                    <p class="text-sm text-slate-400 mb-2">
                        ä½ å¯ä»¥åœ¨ã€Œç”¨æˆ¶ä¸­å¿ƒã€é é¢ç™»å…¥æˆ–è¨»å†Šæ–°å¸³è™Ÿï¼Œä¹‹å¾Œæ‰€æœ‰å®Œæˆçš„é¡Œç›®èˆ‡å­¸ç¿’æ™‚é–“éƒ½æœƒè‡ªå‹•è¨˜éŒ„ã€‚
                    </p>
                    <button onclick="window.location.href='user-system.html'" class="px-4 py-2 rounded-lg bg-emerald-500 text-white text-xs hover:bg-emerald-400">
                        å‰å¾€ç”¨æˆ¶ä¸­å¿ƒç™»å…¥
                    </button>
                </div>
            </section>

            <!-- æ•¸æ“šç¸½è¦½ -->
            <section id="progress-overview" class="grid grid-cols-1 md:grid-cols-4 gap-4 hidden">
                <div class="glass-card p-4">
                    <div class="stat-label">å·²å®Œæˆé¡Œç›®</div>
                    <div id="stat-completed" class="stat-value text-emerald-400">0</div>
                    <div class="text-[11px] text-slate-500 mt-1" id="stat-completed-desc">å®Œæˆè¶Šå¤šé¡Œç›®ï¼Œç†è§£è¶Šæ‰å¯¦</div>
                </div>
                <div class="glass-card p-4">
                    <div class="stat-label">ç­”é¡Œç¸½æ¬¡æ•¸</div>
                    <div id="stat-attempts" class="stat-value text-sky-400">0</div>
                    <div class="text-[11px] text-slate-500 mt-1" id="stat-attempts-desc">æ¯ä¸€æ¬¡å˜—è©¦éƒ½æ˜¯é€²æ­¥çš„æ©Ÿæœƒ</div>
                </div>
                <div class="glass-card p-4">
                    <div class="stat-label">æ­£ç¢ºç‡</div>
                    <div id="stat-accuracy" class="stat-value text-amber-300">0%</div>
                    <div class="text-[11px] text-slate-500 mt-1" id="stat-accuracy-desc">ç›®æ¨™ï¼šç©©å®šåœ¨ 80% ä»¥ä¸Š</div>
                </div>
                <div class="glass-card p-4">
                    <div class="stat-label">ç´¯è¨ˆå­¸ç¿’æ™‚é–“</div>
                    <div id="stat-study-time" class="stat-value text-fuchsia-300">0 åˆ†é˜</div>
                    <div class="text-[11px] text-slate-500 mt-1" id="stat-study-hours">ç´„ 0.0 å°æ™‚</div>
                </div>
            </section>

            <!-- åœ–è¡¨èˆ‡è©³æƒ… -->
            <section id="progress-charts-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6 hidden">
                <div class="glass-card p-6 lg:col-span-2">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-sm font-semibold text-slate-100">æœ€è¿‘å­¸ç¿’è¶¨å‹¢</h2>
                        <button onclick="refreshProgress()" class="text-[11px] text-sky-400 hover:text-sky-300">é‡æ–°æ•´ç†</button>
                    </div>
                    <div id="trend-chart" class="w-full h-64"></div>
                        </div>
                <div class="glass-card p-6">
                    <h2 class="text-sm font-semibold text-slate-100 mb-3">é¡Œå‹åˆ†ä½ˆ</h2>
                    <div id="type-chart" class="w-full h-64"></div>
                </div>
            </section>

            <!-- AI å»ºè­°èˆ‡èªªæ˜ -->
            <section id="progress-ai-section" class="glass-card p-6 md:p-8 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-base md:text-lg font-semibold text-slate-50">AI å­¸ç¿’å»ºè­°</h2>
                    <button id="ai-analysis-btn" onclick="askAIForProgress()" class="px-4 py-1.5 rounded-lg bg-gradient-to-r from-sky-500 to-emerald-500 text-xs font-medium shadow-md shadow-emerald-500/30 hover:from-sky-600 hover:to-emerald-600 transition-all">
                        ğŸ¤– è®“ AI å¹«æˆ‘åˆ†æå­¸ç¿’ç‹€æ³
                    </button>
                </div>
                <p class="text-xs text-slate-400 mb-3">
                    ä»¥ä¸‹æ˜¯æ ¹æ“šä½ ç›®å‰å®Œæˆé¡Œç›®èˆ‡ç­”é¡Œç´€éŒ„ï¼Œç³»çµ±æ•´ç†å‡ºçš„ç°¡å–®å»ºè­°ã€‚ä½ ä¹Ÿå¯ä»¥é»ä¸Šæ–¹æŒ‰éˆ•ï¼Œè«‹ AI å¹«ä½ åšæ›´è©³ç´°çš„åˆ†æã€‚
                </p>
                <ul class="text-sm text-slate-200 space-y-2" id="progress-suggestions">
                    <li>â€¢ å®Œæˆè¶Šå¤šé¡Œç›®ï¼Œçµ±è¨ˆçµæœæœƒè¶Šæº–ç¢ºã€‚</li>
                    <li>â€¢ è‹¥æŸå€‹é¡Œå‹çš„æ­£ç¢ºç‡è¼ƒä½ï¼Œå»ºè­°å›åˆ°é¡Œåº«é‡å°è©²é¡å‹é›†ä¸­ç·´ç¿’ã€‚</li>
                    <li>â€¢ ä¿æŒæ¯é€±è¦å¾‹å­¸ç¿’æ¯”ä¸€æ¬¡åšå¾ˆå¤šé¡Œæ›´é‡è¦ã€‚</li>
                </ul>
                
                <!-- AI åˆ†æçµæœé¡¯ç¤ºå€åŸŸ -->
                <div id="ai-analysis-result" class="hidden mt-6 pt-6 border-t border-slate-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-semibold text-slate-50 flex items-center">
                            <span class="mr-2">ğŸ¤–</span>
                            AI åˆ†æçµæœ
                        </h3>
                        <button onclick="closeAIAnalysis()" class="text-slate-400 hover:text-slate-200 text-xs">
                            âœ• é—œé–‰
                        </button>
                    </div>
                    <div id="ai-analysis-content" class="prose prose-invert prose-sm max-w-none text-slate-200">
                        <!-- AI åˆ†æçµæœå°‡ä»¥ markdown å½¢å¼é¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
        </div>
    </section>
        </div>
    </main>

    <!-- åº•éƒ¨æç¤º -->
    <div id="progress-toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full bg-slate-900/90 border border-slate-700 text-xs text-slate-100 shadow-lg shadow-slate-900/80 hidden z-50"></div>

    <!-- API å®¢æˆ¶ç«¯èˆ‡ AI åŠ©æ‰‹ -->
    <script src="user-api.js"></script>
    <script src="ai-service.js"></script>
    <script src="ai-assistant.js"></script>

    <script>
        let trendChart = null;
        let typeChart = null;

        function showToast(message, type = 'info') {
            const toast = document.getElementById('progress-toast');
            if (!toast) return;
            toast.textContent = message;
            toast.classList.remove('hidden');
            toast.classList.remove('border-emerald-500/60', 'border-rose-500/60', 'border-sky-500/60');
            toast.classList.add(type === 'success' ? 'border-emerald-500/60' :
                                type === 'error' ? 'border-rose-500/60' :
                                'border-sky-500/60');
            setTimeout(() => toast.classList.add('hidden'), 2600);
        }

        async function initProgressPage() {
            const notLogged = document.getElementById('progress-not-logged');
            const overview = document.getElementById('progress-overview');
            const charts = document.getElementById('progress-charts-section');
            const aiSection = document.getElementById('progress-ai-section');

            if (!UserAPI || !UserAPI.isLoggedIn()) {
                notLogged.classList.remove('hidden');
                overview.classList.add('hidden');
                charts.classList.add('hidden');
                aiSection.classList.add('hidden');
                document.getElementById('progress-user-info').textContent = 'å°šæœªç™»å…¥';
                return;
            }

            document.getElementById('progress-user-info').textContent =
                'ç™»å…¥ç”¨æˆ¶ï¼š' + (UserAPI.getCurrentUsername() || 'æœªçŸ¥ç”¨æˆ¶');

            notLogged.classList.add('hidden');
            overview.classList.remove('hidden');
            charts.classList.remove('hidden');
            aiSection.classList.remove('hidden');

            await loadProgressData();

            anime({
                targets: '.glass-card',
                opacity: [0, 1],
                translateY: [20, 0],
                duration: 600,
                delay: anime.stagger(80),
                easing: 'easeOutQuad'
            });
        }

        async function loadProgressData() {
            try {
                const res = await UserAPI.getProgress();
                if (!res.success || !res.progress) {
                    showToast('æš«æ™‚ç„¡æ³•è¼‰å…¥é€²åº¦è³‡æ–™', 'error');
                    return;
                }

                const p = res.progress;
                const completedExercises = p.completed_exercises || [];
                const scores = p.scores || {};
                const studyTime = p.study_time || 0;
                const totalScore = p.total_score || 0;

                const totalAttempts = Object.values(scores).reduce((sum, arr) => {
                    if (Array.isArray(arr)) return sum + arr.length;
                    return sum;
                }, 0);
                const correctAnswers = totalScore / 100; // å‡è¨­æ¯é¡Œ 100 åˆ†
                const accuracy = totalAttempts > 0 ? Math.round((correctAnswers / totalAttempts) * 100) : 0;

                // æ›´æ–°ç¸½è¦½çµ±è¨ˆ
                document.getElementById('stat-completed').textContent = completedExercises.length;
                document.getElementById('stat-attempts').textContent = totalAttempts;
                document.getElementById('stat-accuracy').textContent = accuracy + '%';
                document.getElementById('stat-study-time').textContent = `${studyTime} åˆ†é˜`;
                document.getElementById('stat-study-hours').textContent = `ç´„ ${(studyTime / 60).toFixed(1)} å°æ™‚`;

                // åˆå§‹åŒ– / æ›´æ–°åœ–è¡¨
                initCharts(scores, completedExercises.length);

                // æ ¹æ“šæ•¸æ“šæ›´æ–°ç°¡å–®å»ºè­°æ–‡å­—
                const suggestions = [];
                if (completedExercises.length < 20) {
                    suggestions.push('ç›®å‰å®Œæˆé¡Œç›®æ•¸è¼ƒå°‘ï¼Œå»ºè­°å…ˆé›†ä¸­å®ŒæˆåŸºç¤é¡Œç›®ä»¥å»ºç«‹ä¿¡å¿ƒã€‚');
                } else {
                    suggestions.push('ä½ å·²å®Œæˆä¸å°‘é¡Œç›®ï¼Œå¯ä»¥é–‹å§‹æŒ‘æˆ°é›£åº¦è¼ƒé«˜çš„ JOIN / å­æŸ¥è©¢é¡Œç›®ã€‚');
                }
                if (accuracy < 60 && totalAttempts > 0) {
                    suggestions.push('æ­£ç¢ºç‡ä½æ–¼ 60%ï¼Œå¯ä»¥æŠŠå¸¸éŒ¯çš„é¡Œå‹è¨˜éŒ„ä¸‹ä¾†ï¼Œå†è«‹ AI å¹«ä½ æ•´ç†é‡é»ã€‚');
                } else if (accuracy >= 80) {
                    suggestions.push('æ­£ç¢ºç‡å·²è¶…é 80%ï¼Œè¡¨ç¾å¾ˆå¥½ï¼Œå¯ä»¥å¤šåšç¶œåˆç·´ç¿’éå›ºã€‚');
                }
                if (studyTime < 120) {
                    suggestions.push('ç´¯è¨ˆå­¸ç¿’æ™‚é–“å°‘æ–¼ 2 å°æ™‚ï¼Œå»ºè­°å®‰æ’å›ºå®šæ™‚æ®µæ¯æ—¥ç·´ç¿’ 20â€“30 åˆ†é˜ã€‚');
                }

                const sugEl = document.getElementById('progress-suggestions');
                if (suggestions.length > 0 && sugEl) {
                    sugEl.innerHTML = suggestions.map(s => `<li>â€¢ ${s}</li>`).join('');
                }
            } catch (e) {
                console.error('è¼‰å…¥é€²åº¦å¤±æ•—:', e);
                showToast('è¼‰å…¥é€²åº¦æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        function initCharts(scores, completedCount) {
            const trendDom = document.getElementById('trend-chart');
            const typeDom = document.getElementById('type-chart');
            if (!trendDom || !typeDom || typeof echarts === 'undefined') return;

            const typeKeys = ['fill-blank', 'card-arrangement', 'drag-drop', 'sql-practice'];
            const typeLabels = ['å¡«ç©ºé¡Œ', 'å¡ç‰‡æ’åˆ—', 'æ‹–æ”¾ç·´ç¿’', 'æ•´å¥è¼¸å…¥'];
            const typeCounts = typeKeys.map(k => (Array.isArray(scores[k]) ? scores[k].length : 0));

            if (!trendChart) trendChart = echarts.init(trendDom);
            if (!typeChart) typeChart = echarts.init(typeDom);
            
            const trendOption = {
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: ['å®Œæˆé¡Œç›®', 'ç­”é¡Œæ¬¡æ•¸', 'ç¸½ç©åˆ†'] },
                yAxis: { type: 'value' },
                series: [
                    {
                        name: 'å­¸ç¿’è¡¨ç¾',
                        type: 'bar',
                        data: [completedCount, typeCounts.reduce((a, b) => a + b, 0), 0],
                        itemStyle: { color: '#22c55e' }
                        }
                ]
            };

            const typeOption = {
                tooltip: { trigger: 'item' },
                legend: { top: 0, textStyle: { color: '#e5e7eb', fontSize: 11 } },
                series: [
                    {
                        name: 'é¡Œå‹åˆ†ä½ˆ',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 6,
                            borderColor: '#020617',
                            borderWidth: 2
                        },
                        label: { show: false },
                        emphasis: { label: { show: true, fontSize: 12, fontWeight: 'bold' } },
                        labelLine: { show: false },
                        data: typeLabels.map((name, idx) => ({
                            value: typeCounts[idx],
                            name
                        }))
                    }
                ]
            };
            
            trendChart.setOption(trendOption);
            typeChart.setOption(typeOption);
        }

        function refreshProgress() {
            loadProgressData();
            showToast('å·²é‡æ–°æ•´ç†æœ€æ–°é€²åº¦', 'success');
        }

        async function askAIForProgress() {
            const btn = document.getElementById('ai-analysis-btn');
            const resultDiv = document.getElementById('ai-analysis-result');
            const contentDiv = document.getElementById('ai-analysis-content');
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'â³ AI æ­£åœ¨åˆ†æä¸­...';
            }
            
            if (resultDiv && contentDiv) {
                resultDiv.classList.remove('hidden');
                contentDiv.innerHTML = '<div class="flex items-center justify-center py-8"><div class="text-slate-400">â³ AI æ­£åœ¨åˆ†æä½ çš„å­¸ç¿’ç‹€æ³ï¼Œè«‹ç¨å€™...</div></div>';
            }
            
            try {
                if (typeof AIService === 'undefined') {
                    showToast('AI æœå‹™å°šæœªè¼‰å…¥', 'error');
                    if (resultDiv) resultDiv.classList.add('hidden');
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'ğŸ¤– è®“ AI å¹«æˆ‘åˆ†æå­¸ç¿’ç‹€æ³';
                    }
                    return;
        }
                const res = await UserAPI.getProgress();
                if (!res.success || !res.progress) {
                    showToast('æš«æ™‚ç„¡æ³•å–å¾—é€²åº¦è³‡æ–™', 'error');
                    if (resultDiv) resultDiv.classList.add('hidden');
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'ğŸ¤– è®“ AI å¹«æˆ‘åˆ†æå­¸ç¿’ç‹€æ³';
                    }
                    return;
                }

                const p = res.progress;
                const message = `
è«‹æ ¹æ“šä»¥ä¸‹å­¸ç¿’æ•¸æ“šï¼Œå¹«æˆ‘åˆ†æç›®å‰çš„å­¸ç¿’ç‹€æ³ï¼Œä¸¦çµ¦å‡ºå…·é«”å»ºè­°ï¼š

- å·²å®Œæˆé¡Œç›®æ•¸ï¼š${(p.completed_exercises || []).length}
- é¡Œå‹åˆ†ä½ˆï¼ˆJSONï¼‰ï¼š${JSON.stringify(p.scores || {})}
- ç´¯è¨ˆå­¸ç¿’æ™‚é–“ï¼š${p.study_time || 0} åˆ†é˜
- ç­‰ç´šï¼š${p.level || 1}
- ç¸½ç©åˆ†ï¼š${p.total_score || 0}

è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä½¿ç”¨ Markdown æ ¼å¼ï¼Œçµæ§‹æ¸…æ™°ï¼Œé©åˆä¸­å­¸ç”Ÿé–±è®€ã€‚è«‹åŒ…å«ä»¥ä¸‹å…§å®¹ï¼š
1. **æˆ‘çš„å„ªå‹¢æ˜¯ä»€éº¼ï¼Ÿ** - åˆ†ææˆ‘è¡¨ç¾è¼ƒå¥½çš„éƒ¨åˆ†
2. **å“ªäº›é¡Œå‹æˆ–æ¦‚å¿µéœ€è¦åŠ å¼·ï¼Ÿ** - æŒ‡å‡ºéœ€è¦æ”¹é€²çš„åœ°æ–¹
3. **æ¥ä¸‹ä¾† 1â€“2 é€±çš„å­¸ç¿’è¨ˆåŠƒå»ºè­°** - çµ¦å‡ºå…·é«”çš„å­¸ç¿’å»ºè­°

è«‹ä½¿ç”¨æ¨™é¡Œã€åˆ—è¡¨ã€å¼·èª¿ç­‰ Markdown æ ¼å¼ï¼Œè®“å…§å®¹æ›´æ˜“è®€ã€‚`;

                const reply = await AIService.chat(message, 'ä½ æ˜¯ä¸€ä½ DSE SQL è£œç¿’è€å¸«ï¼Œæ­£åœ¨å¹«å­¸ç”Ÿæª¢è¦–å­¸ç¿’æ•¸æ“šä¸¦è¨­è¨ˆè®€æ›¸è¨ˆåŠƒã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä½¿ç”¨ Markdown æ ¼å¼ã€‚', 0.6);

                // é¡¯ç¤ºåœ¨ç¶²é ä¸­çš„ markdown å€åŸŸ
                const resultDiv = document.getElementById('ai-analysis-result');
                const contentDiv = document.getElementById('ai-analysis-content');
                const btn = document.getElementById('ai-analysis-btn');
                
                if (resultDiv && contentDiv) {
                    // é¡¯ç¤ºçµæœå€åŸŸ
                    resultDiv.classList.remove('hidden');
                    
                    // ä½¿ç”¨ marked.js æ¸²æŸ“ markdown
                    if (typeof marked !== 'undefined') {
                        try {
                            const html = marked.parse(reply || 'AI è¿”å›äº†ç©ºå…§å®¹ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚');
                            contentDiv.innerHTML = html;
                        } catch (e) {
                            console.error('Markdown æ¸²æŸ“å¤±æ•—:', e);
                            contentDiv.innerHTML = '<div class="text-red-400">Markdown æ¸²æŸ“å¤±æ•—ï¼Œé¡¯ç¤ºåŸå§‹å…§å®¹ï¼š</div><pre class="mt-2 text-sm whitespace-pre-wrap">' + (reply || 'AI è¿”å›äº†ç©ºå…§å®¹') + '</pre>';
                        }
                    } else {
                        // å¦‚æœ marked.js æœªåŠ è¼‰ï¼Œé¡¯ç¤ºç´”æ–‡æœ¬
                        contentDiv.innerHTML = '<pre class="whitespace-pre-wrap text-sm">' + (reply || 'AI è¿”å›äº†ç©ºå…§å®¹ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚') + '</pre>';
                    }
                    
                    // æ»¾å‹•åˆ°åˆ†æçµæœå€åŸŸ
                    setTimeout(() => {
                        resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                } else {
                    // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œä½¿ç”¨èˆŠçš„æ–¹å¼
                    if (window.aiAssistant && typeof window.aiAssistant.showMessage === 'function') {
                        window.aiAssistant.openSidebar && window.aiAssistant.openSidebar();
                        window.aiAssistant.showMessage('assistant', reply || 'AI è¿”å›äº†ç©ºå…§å®¹ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚');
                    } else {
                        alert(reply || 'AI è¿”å›äº†ç©ºå…§å®¹ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚');
                    }
                }
                
                showToast('AI åˆ†æå®Œæˆ', 'success');
            } catch (e) {
                console.error(e);
                showToast('å‘ AI è¦æ±‚åˆ†ææ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
                const resultDiv = document.getElementById('ai-analysis-result');
                const contentDiv = document.getElementById('ai-analysis-content');
                if (resultDiv && contentDiv) {
                    resultDiv.classList.remove('hidden');
                    contentDiv.innerHTML = '<div class="text-red-400">âŒ åˆ†æå¤±æ•—ï¼š' + (e.message || 'æœªçŸ¥éŒ¯èª¤') + '</div>';
        }
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                const btn = document.getElementById('ai-analysis-btn');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸ¤– è®“ AI å¹«æˆ‘åˆ†æå­¸ç¿’ç‹€æ³';
                }
            }
        }
        
        function closeAIAnalysis() {
            const resultDiv = document.getElementById('ai-analysis-result');
            if (resultDiv) {
                resultDiv.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', initProgressPage);
    </script>
</body>
</html>

