# 完整部署与维护指南

## 🎉 部署成功确认

您的网站 `https://icthelper.duckdns.org` 已成功部署并配置了完整的安全体系！

## ✅ 当前部署架构

### 核心访问路径

```
用户浏览器 
  ↓ HTTPS (加密)
您的域名 (icthelper.duckdns.org) 
  ↓
NPM (host模式) 
  ↓
宿主机服务 (127.0.0.1:5000)
```

### 安全加固措施

1. **SSL/TLS 加密**
   - ✅ 通过 `acme.sh` 申请并配置 Let's Encrypt 证书
   - ✅ 实现 HTTPS 安全访问
   - ✅ 证书有效期：90 天

2. **IP 直连封锁**
   - ✅ `http://IP:5000` 被 UFW 防火墙规则明确拒绝
   - ✅ `http://IP:80/443` 被 NPM 默认站点配置返回 444（连接重置）
   - ✅ 只能通过 HTTPS 域名访问

3. **网络配置**
   - ✅ NPM 使用 `host` 网络模式
   - ✅ 避免容器网络路由复杂性
   - ✅ 配置更稳定可靠

## 📋 维护检查清单

### 定期维护（每月）

- [ ] 访问 `https://icthelper.duckdns.org` 验证网站正常
- [ ] 测试 `http://你的IP:5000` 确认被防火墙拒绝
- [ ] 运行 `./check-ssl-cert.sh` 检查证书状态
- [ ] 检查后端服务运行状态
- [ ] 查看 NPM 日志确认无异常

### 证书维护（每 60-90 天）

- [ ] 检查证书是否已自动续期（acme.sh）
- [ ] 获取新证书文件（`fullchain.cer` 和 `.key`）
- [ ] 登录 NPM 后台更新证书
- [ ] 验证 HTTPS 访问正常

## 🔧 日常管理操作

### 1. 网站配置管理

**位置**：NPM 后台 (`http://你的IP:81`)

- **Proxy Hosts**：管理网站配置
- **SSL Certificates**：管理 SSL 证书
- **Access Lists**：管理访问控制
- **Redirection Hosts**：管理重定向规则

### 2. 防火墙管理

```bash
# 查看防火墙状态
sudo ufw status numbered

# 查看详细规则
sudo ufw status verbose

# 删除规则
sudo ufw delete [编号]

# 添加新规则
sudo ufw allow [端口]/tcp
sudo ufw deny [端口]/tcp

# 重新加载防火墙
sudo ufw reload
```

### 3. 容器管理

```bash
# 查看容器状态
sudo docker ps

# 查看 NPM 容器日志
sudo docker logs npm

# 重启 NPM 容器
sudo docker restart npm

# 查看容器详细信息
sudo docker inspect npm
```

### 4. 后端服务管理

**使用 GUI 服务管理器**：
```bash
python3 service-manager.py
```

功能：
- ✅ 启动/停止/重启后端服务
- ✅ 查看实时日志
- ✅ 系统资源监控
- ✅ 快速访问网站页面
- ✅ NPM 管理界面快速访问
- ✅ 数据库和用户管理

## 📝 SSL 证书维护流程

### 自动续期

`acme.sh` 已设置自动续期任务，会在证书到期前约 60 天自动续签。

**检查自动续期任务**：
```bash
crontab -l | grep acme
```

### 手动更新到 NPM（重要）

证书续期后，必须手动更新到 NPM：

1. **获取新证书文件**
   ```bash
   # 证书文件路径
   ~/.acme.sh/icthelper.duckdns.org_ecc/icthelper.duckdns.org.cer  # fullchain
   ~/.acme.sh/icthelper.duckdns.org_ecc/icthelper.duckdns.org.key   # 私钥
   ```

2. **查看证书内容**
   ```bash
   cat ~/.acme.sh/icthelper.duckdns.org_ecc/icthelper.duckdns.org.cer
   cat ~/.acme.sh/icthelper.duckdns.org_ecc/icthelper.duckdns.org.key
   ```

3. **更新到 NPM**
   - 登录 NPM 后台：`http://你的IP:81`
   - 进入 **SSL Certificates**
   - 找到 `icthelper.duckdns.org` 的自定义证书
   - 点击 **Edit**
   - 将新的 `fullchain.cer` 内容复制到 **Certificate**
   - 将新的 `.key` 内容复制到 **Private Key**
   - 点击 **Save**

4. **验证更新**
   ```bash
   # 检查证书有效期
   echo | openssl s_client -servername icthelper.duckdns.org -connect icthelper.duckdns.org:443 2>/dev/null | openssl x509 -noout -dates
   
   # 测试 HTTPS 访问
   curl -I https://icthelper.duckdns.org
   ```

### 证书维护时间表

| 时间 | 操作 | 说明 |
| :--- | :--- | :--- |
| **证书申请后** | 设置提醒 | 在日历上设置 80 天后的提醒 |
| **到期前 30 天** | 检查证书状态 | 运行 `./check-ssl-cert.sh` |
| **到期前 60 天** | 自动续期 | acme.sh 自动尝试续期 |
| **续期成功后** | 更新到 NPM | 立即更新证书到 NPM |
| **更新后** | 验证访问 | 确认 HTTPS 访问正常 |

## 🛠️ 故障排除

### 网站无法访问

1. **检查后端服务**
   ```bash
   # 检查服务是否运行
   ps aux | grep "python.*app.py"
   
   # 检查端口监听
   ss -tlnp | grep :5000
   ```

2. **检查 NPM 容器**
   ```bash
   sudo docker ps | grep npm
   sudo docker logs npm --tail 50
   ```

3. **检查防火墙**
   ```bash
   sudo ufw status
   ```

4. **检查 DNS**
   ```bash
   dig icthelper.duckdns.org
   nslookup icthelper.duckdns.org
   ```

### 证书问题

1. **证书过期**
   ```bash
   # 手动触发续期
   acme.sh --renew -d icthelper.duckdns.org --force
   
   # 查看续期日志
   tail -f ~/.acme.sh/acme.sh.log
   ```

2. **证书链不完整**
   - 确保 NPM 中的 Certificate 字段包含完整证书链
   - 包括终端证书和中间证书

3. **浏览器证书警告**
   - 检查证书是否过期
   - 检查系统时间是否正确
   - 清除浏览器缓存

### 防火墙问题

```bash
# 查看防火墙规则
sudo ufw status numbered

# 临时禁用防火墙（仅用于测试）
sudo ufw disable

# 重新启用防火墙
sudo ufw enable

# 查看防火墙日志
sudo tail -f /var/log/ufw.log
```

## 📊 监控和检查工具

### 1. 证书检查脚本

```bash
./check-ssl-cert.sh
```

检查内容：
- ✅ 证书文件是否存在
- ✅ 证书有效期和剩余天数
- ✅ HTTPS 连接状态
- ✅ 自动续期任务状态

### 2. 在线验证工具

- **SSL Labs SSL Test**：https://www.ssllabs.com/ssltest/analyze.html?d=icthelper.duckdns.org
- **Certificate Transparency**：https://crt.sh/?q=icthelper.duckdns.org
- **SSL Checker**：https://www.sslshopper.com/ssl-checker.html

### 3. GUI 服务管理器

```bash
python3 service-manager.py
```

功能：
- 系统资源监控（CPU、内存、磁盘、温度）
- 网站访问次数趋势图
- 用户学习进度统计
- 快速访问网站和 NPM
- 数据库和用户管理

## 🔐 安全最佳实践

### 当前已实施

- ✅ HTTPS 强制加密
- ✅ IP 直连封锁
- ✅ 防火墙规则配置
- ✅ 域名访问限制

### 建议加强（可选）

- [ ] 定期更新系统和软件包
- [ ] 配置自动安全更新
- [ ] 设置强密码策略
- [ ] 启用访问日志监控
- [ ] 配置备份策略
- [ ] 设置异常访问告警

## 📅 维护时间表

### 每日

- 检查后端服务运行状态（GUI 自动监控）

### 每周

- 查看 NPM 日志
- 检查系统资源使用情况

### 每月

- 运行证书检查脚本
- 验证网站访问正常
- 检查防火墙状态

### 每 60-90 天

- 证书续期和更新
- 全面安全检查

## 🎯 关键配置文件位置

| 文件/目录 | 路径 | 说明 |
| :--- | :--- | :--- |
| **证书文件** | `~/.acme.sh/icthelper.duckdns.org_ecc/` | SSL 证书存储 |
| **NPM 配置** | NPM 后台管理 | 网站和证书配置 |
| **后端代码** | `/home/yivh/桌面/web surver/` | Flask 后端服务 |
| **GUI 配置** | `npm_config.json` | NPM 地址配置 |
| **域名配置** | `domain_config.json` | 域名和 IP 配置 |
| **防火墙规则** | `/etc/ufw/` | UFW 防火墙配置 |

## 💡 快速参考命令

```bash
# 检查证书状态
./check-ssl-cert.sh

# 查看后端服务
ps aux | grep "python.*app.py"

# 查看 NPM 容器
sudo docker ps | grep npm
sudo docker logs npm --tail 50

# 检查防火墙
sudo ufw status numbered

# 测试 HTTPS
curl -I https://icthelper.duckdns.org

# 测试 IP 封锁（应该被拒绝）
curl -I http://你的IP:5000
```

## 🎉 总结

您已经成功构建了一个**专业级的安全 Web 服务部署**：

- ✅ 安全的 HTTPS 访问
- ✅ IP 直连封锁
- ✅ 完整的防火墙配置
- ✅ 自动化证书管理
- ✅ 便捷的管理工具

**恭喜您完成了一个从零到一的完整安全部署！** 🚀

如果在后续使用或维护中遇到任何问题，随时可以查看相关文档或寻求帮助。

