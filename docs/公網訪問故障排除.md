# 🌐 公網訪問故障排除指南

## 問題：無法通過公網 IP 59.148.148.76:5000 訪問服務

### 🔍 快速診斷

運行診斷腳本：
```bash
chmod +x check-public-access.sh
./check-public-access.sh
```

### ✅ 檢查清單

#### 1. 服務是否運行？

```bash
# 檢查服務進程
ps aux | grep "python.*app.py" | grep -v grep

# 檢查端口監聽
ss -tlnp | grep :5000
# 或
netstat -tlnp | grep :5000
```

**如果服務未運行：**
```bash
cd "/home/yivh/web surver"
python3 app.py
```

#### 2. 服務是否監聽在 0.0.0.0？

**檢查方法：**
```bash
ss -tlnp | grep :5000
```

**應該看到：**
```
LISTEN 0 128 0.0.0.0:5000 0.0.0.0:*
```

**如果只看到 127.0.0.1:5000，說明服務只監聽本地，需要修改 app.py：**

```python
# 確保這一行是：
app.run(host='0.0.0.0', port=port, debug=debug, threaded=True)
# 而不是：
app.run(host='127.0.0.1', port=port, debug=debug, threaded=True)
```

#### 3. Linux 防火牆是否開放端口？

**檢查 UFW：**
```bash
sudo ufw status
```

**如果端口未開放，運行：**
```bash
chmod +x fix-firewall.sh
./fix-firewall.sh
```

**或手動配置：**
```bash
# UFW
sudo ufw allow 5000/tcp
sudo ufw reload

# firewalld
sudo firewall-cmd --add-port=5000/tcp --permanent
sudo firewall-cmd --reload

# iptables
sudo iptables -I INPUT -p tcp --dport 5000 -j ACCEPT
```

#### 4. 路由器端口映射是否正確？

**檢查項目：**
- 外部端口：5000
- 內部 IP：192.168.3.10（您的內網 IP）
- 內部端口：5000
- 協議：TCP
- 狀態：已啟用

**常見問題：**
- 端口映射未啟用
- 內部 IP 地址錯誤（應是服務器內網 IP）
- 外部端口和內部端口不一致

#### 5. 服務提供商是否阻止端口？

某些 ISP（互聯網服務提供商）會阻止常見端口（如 80、443、5000 等）。

**解決方案：**
- 嘗試使用其他端口（如 8080、8888）
- 聯繫 ISP 確認是否阻止端口
- 使用非標準端口（如 12345）

#### 6. 本地測試

**測試本地連接：**
```bash
curl http://localhost:5000/health
```

**測試內網連接：**
```bash
curl http://192.168.3.10:5000/health
```

**測試公網連接（從外部網絡）：**
```bash
curl http://59.148.148.76:5000/health
```

### 🛠️ 完整修復步驟

#### 步驟 1：啟動服務

```bash
cd "/home/yivh/web surver"
python3 app.py
```

確認輸出顯示：
```
服務地址: http://0.0.0.0:5000
```

#### 步驟 2：配置防火牆

```bash
chmod +x fix-firewall.sh
./fix-firewall.sh
```

#### 步驟 3：驗證本地訪問

```bash
curl http://localhost:5000/health
```

應該返回：
```json
{"status":"ok","service":"DSE SQL 訓練營 完整服务",...}
```

#### 步驟 4：檢查路由器配置

登錄路由器管理界面，確認：
- 端口轉發規則已啟用
- 外部端口：5000
- 內部 IP：192.168.3.10
- 內部端口：5000
- 協議：TCP

#### 步驟 5：從外部測試

**方法 1：使用手機（4G/5G 網絡）**
```
訪問：http://59.148.148.76:5000/health
```

**方法 2：使用在線工具**
- https://www.yougetsignal.com/tools/open-ports/
- 輸入 IP: 59.148.148.76，端口: 5000

**方法 3：使用 curl（從其他服務器）**
```bash
curl http://59.148.148.76:5000/health
```

### 🔧 進階排查

#### 檢查服務監聽地址

```bash
# 查看詳細監聽信息
sudo ss -tlnp | grep :5000
sudo netstat -tlnp | grep :5000
```

#### 檢查防火牆規則

```bash
# UFW
sudo ufw status numbered

# firewalld
sudo firewall-cmd --list-all

# iptables
sudo iptables -L -n | grep 5000
```

#### 使用 tcpdump 監聽連接

```bash
sudo tcpdump -i any -n port 5000
```

然後從外部嘗試連接，看是否有數據包到達。

#### 檢查系統日誌

```bash
# 查看系統日誌
sudo journalctl -u your-service-name
# 或
sudo dmesg | tail -50
```

### ⚠️ 常見錯誤

#### 錯誤 1：連接超時

**原因：**
- 防火牆阻止
- 端口映射未配置
- 服務未運行

**解決：**
1. 檢查服務狀態
2. 檢查防火牆
3. 檢查端口映射

#### 錯誤 2：連接被拒絕

**原因：**
- 服務只監聽 localhost
- 服務未運行

**解決：**
1. 確認 app.py 中 `host='0.0.0.0'`
2. 重啟服務

#### 錯誤 3：可以訪問但很慢

**原因：**
- 網絡延遲
- 服務器資源不足

**解決：**
1. 檢查服務器 CPU/內存使用
2. 優化服務配置

### 📝 配置示例

#### 修改端口（如果 5000 被阻止）

**1. 修改 app.py：**
```python
port = int(os.environ.get('PORT', 8080))  # 改為 8080
```

**2. 更新端口映射：**
- 外部端口：8080
- 內部端口：8080

**3. 更新防火牆：**
```bash
sudo ufw allow 8080/tcp
```

**4. 訪問地址：**
```
http://59.148.148.76:8080
```

### 🎯 測試命令總結

```bash
# 1. 檢查服務
ps aux | grep "python.*app.py"

# 2. 檢查端口
ss -tlnp | grep :5000

# 3. 測試本地
curl http://localhost:5000/health

# 4. 測試內網
curl http://192.168.3.10:5000/health

# 5. 檢查防火牆
sudo ufw status

# 6. 診斷腳本
./check-public-access.sh
```

### 💡 提示

1. **使用非標準端口**：如果 ISP 阻止 5000 端口，嘗試使用 8080、8888、12345 等
2. **使用反向代理**：配置 Nginx 作為反向代理，使用 80/443 端口
3. **使用 VPN**：如果無法配置端口映射，可以使用 VPN 服務
4. **檢查 IP 地址**：確認 59.148.148.76 是您當前的公網 IP（可能動態變化）

### 📞 需要幫助？

如果以上步驟都無法解決問題，請提供：
1. `./check-public-access.sh` 的完整輸出
2. `ss -tlnp | grep :5000` 的輸出
3. `sudo ufw status` 的輸出（如果使用 UFW）
4. 路由器端口映射配置截圖

---

**最後更新：** 2025-12-17

