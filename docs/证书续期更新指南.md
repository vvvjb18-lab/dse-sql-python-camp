# 证书续期更新指南

## 📋 快速参考

- **域名**：`icthelper.duckdns.org`
- **证书路径**：`~/.acme.sh/icthelper.duckdns.org_ecc/`
- **证书文件**：
  - `icthelper.duckdns.org.cer` (fullchain)
  - `icthelper.duckdns.org.key` (私钥)

## 🔄 续期更新流程（约60-80天后）

### 步骤1：检查证书状态

```bash
# 运行检查脚本
./check-ssl-cert.sh

# 或手动检查
acme.sh --info -d icthelper.duckdns.org
```

### 步骤2：确认证书已自动续期

acme.sh 会在证书到期前约60天自动续期。检查续期日志：

```bash
# 查看 acme.sh 日志
tail -f ~/.acme.sh/acme.sh.log

# 查看证书到期时间
openssl x509 -in ~/.acme.sh/icthelper.duckdns.org_ecc/icthelper.duckdns.org.cer -noout -dates
```

### 步骤3：获取新证书内容

```bash
# 查看 fullchain 证书内容
cat ~/.acme.sh/icthelper.duckdns.org_ecc/icthelper.duckdns.org.cer

# 查看私钥内容
cat ~/.acme.sh/icthelper.duckdns.org_ecc/icthelper.duckdns.org.key
```

### 步骤4：更新到 NPM

1. **登录 Nginx Proxy Manager**
   - 访问 NPM 管理界面

2. **进入 SSL Certificates**
   - 左侧菜单：**SSL Certificates**

3. **找到证书**
   - 找到 `icthelper.duckdns.org` 的自定义证书
   - 点击 **Edit**（编辑）

4. **更新证书内容**
   - **Certificate**：粘贴新的 `icthelper.duckdns.org.cer` 内容
   - **Private Key**：粘贴新的 `icthelper.duckdns.org.key` 内容
   - 点击 **Save**（保存）

5. **验证更新**
   - 等待几秒钟让 NPM 重新加载证书
   - 访问 `https://icthelper.duckdns.org` 验证

### 步骤5：验证证书

```bash
# 检查证书有效期
echo | openssl s_client -servername icthelper.duckdns.org -connect icthelper.duckdns.org:443 2>/dev/null | openssl x509 -noout -dates

# 测试 HTTPS 访问
curl -I https://icthelper.duckdns.org
```

## ⚠️ 重要提醒

1. **自动续期但需手动更新**：acme.sh 会自动续期证书，但不会自动更新到 NPM，必须手动更新。

2. **设置提醒**：建议在日历上设置 **80天后** 的提醒，用于检查并更新证书。

3. **提前准备**：建议在证书到期前 30 天就开始检查，确保有足够时间处理。

4. **备份证书**：更新前建议备份旧证书，以防出现问题。

## 🛠️ 故障排除

### 证书续期失败

```bash
# 手动触发续期
acme.sh --renew -d icthelper.duckdns.org --force

# 查看详细日志
acme.sh --renew -d icthelper.duckdns.org --debug
```

### NPM 证书更新后不生效

1. 检查证书格式是否正确（包含完整的证书链）
2. 重启 NPM 服务
3. 清除浏览器缓存
4. 检查 NPM 错误日志

### 证书过期

如果证书已过期：

1. 立即手动续期：
   ```bash
   acme.sh --renew -d icthelper.duckdns.org --force
   ```

2. 更新到 NPM（按步骤4）

3. 验证 HTTPS 访问

## 📅 维护计划

### 每月检查（建议）

运行检查脚本：
```bash
./check-ssl-cert.sh
```

### 续期后操作（约60-80天后）

1. ✅ 检查证书是否已自动续期
2. ✅ 获取新证书文件
3. ✅ 更新到 NPM
4. ✅ 验证 HTTPS 访问正常
5. ✅ 设置下一个提醒

## 📝 记录模板

建议记录以下信息，方便未来管理：

```
域名：icthelper.duckdns.org
证书路径：~/.acme.sh/icthelper.duckdns.org_ecc/
上次更新：2025-12-19
下次检查：2026-03-19（约90天后）
NPM 证书名称：icthelper.duckdns.org
```

