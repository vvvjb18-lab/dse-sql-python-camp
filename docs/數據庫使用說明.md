# 數據庫使用說明

## 概述

本系統使用 SQLite 數據庫存儲用戶登錄信息、個人資料和學習進度。

## 數據庫初始化

### 方法1：使用初始化腳本（推薦）

```bash
python3 init_database.py
```

### 方法2：自動初始化

當後端服務啟動時，如果數據庫不存在，會自動創建。

## 數據庫結構

### 1. users 表（用戶表）
存儲用戶基本登錄信息：
- `id`: 用戶ID（主鍵，自增）
- `username`: 用戶名（唯一）
- `email`: 電子郵件（唯一）
- `password_hash`: 密碼哈希值（SHA256）
- `created_at`: 創建時間
- `updated_at`: 更新時間
- `last_login`: 最後登錄時間
- `is_active`: 是否激活（1=激活，0=禁用）

### 2. user_profiles 表（用戶資料表）
存儲用戶個人資料：
- `id`: 記錄ID（主鍵，自增）
- `user_id`: 用戶ID（外鍵，關聯users表）
- `full_name`: 全名
- `avatar_url`: 頭像URL
- `bio`: 個人簡介
- `phone`: 電話號碼
- `birth_date`: 出生日期
- `gender`: 性別
- `location`: 所在地
- `preferences`: 用戶偏好設置（JSON格式）
- `created_at`: 創建時間
- `updated_at`: 更新時間

### 3. user_progress 表（用戶學習進度表）
存儲用戶學習進度：
- `id`: 記錄ID（主鍵，自增）
- `user_id`: 用戶ID（外鍵，關聯users表）
- `completed_exercises`: 完成的練習ID列表（JSON格式）
- `scores`: 各類型練習的分數（JSON格式）
- `study_time`: 學習時長（分鐘）
- `achievements`: 成就列表（JSON格式）
- `level`: 用戶等級
- `total_score`: 總分數
- `join_date`: 加入日期
- `last_study_date`: 最後學習日期
- `created_at`: 創建時間
- `updated_at`: 更新時間

### 4. user_sessions 表（用戶會話表）
存儲用戶登錄會話：
- `id`: 會話ID（主鍵，自增）
- `user_id`: 用戶ID（外鍵，關聯users表）
- `session_token`: 會話令牌（唯一）
- `created_at`: 創建時間
- `expires_at`: 過期時間
- `ip_address`: IP地址
- `user_agent`: 用戶代理

## API 接口說明

### 1. 用戶註冊
**POST** `/api/user/register`

請求體：
```json
{
    "username": "testuser",
    "email": "test@example.com",
    "password": "password123"
}
```

響應：
```json
{
    "success": true,
    "user_id": 1,
    "username": "testuser"
}
```

### 2. 用戶登錄
**POST** `/api/user/login`

請求體：
```json
{
    "username": "testuser",
    "password": "password123"
}
```

響應：
```json
{
    "success": true,
    "user_id": 1,
    "username": "testuser",
    "email": "test@example.com",
    "session_token": "xxx..."
}
```

### 3. 用戶登出
**POST** `/api/user/logout`

請求體：
```json
{
    "session_token": "xxx..."
}
```

### 4. 獲取用戶資料
**GET** `/api/user/profile?user_id=1&session_token=xxx...`

響應：
```json
{
    "success": true,
    "profile": {
        "id": 1,
        "username": "testuser",
        "email": "test@example.com",
        "full_name": "測試用戶",
        ...
    }
}
```

### 5. 更新用戶資料
**PUT** `/api/user/profile`

請求體：
```json
{
    "user_id": 1,
    "session_token": "xxx...",
    "full_name": "新名字",
    "bio": "個人簡介",
    "gender": "male",
    "location": "香港"
}
```

### 6. 獲取用戶學習進度
**GET** `/api/user/progress?user_id=1&session_token=xxx...`

響應：
```json
{
    "success": true,
    "progress": {
        "user_id": 1,
        "completed_exercises": [...],
        "scores": {...},
        "study_time": 120,
        "level": 3,
        "total_score": 500
    }
}
```

### 7. 更新用戶學習進度
**PUT** `/api/user/progress`

請求體：
```json
{
    "user_id": 1,
    "session_token": "xxx...",
    "completed_exercises": ["ex1", "ex2"],
    "scores": {
        "fill-blank": [...],
        "sql-practice": [...]
    },
    "study_time": 150,
    "level": 4,
    "total_score": 600
}
```

### 8. 檢查用戶名是否存在
**POST** `/api/user/check-username`

請求體：
```json
{
    "username": "testuser"
}
```

響應：
```json
{
    "success": true,
    "exists": true
}
```

### 9. 檢查郵箱是否存在
**POST** `/api/user/check-email`

請求體：
```json
{
    "email": "test@example.com"
}
```

### 10. 驗證會話
**GET** `/api/user/session?session_token=xxx...`

## 前端集成示例

### JavaScript 註冊示例
```javascript
async function register(username, email, password) {
    const response = await fetch('/api/user/register', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            username: username,
            email: email,
            password: password
        })
    });
    return await response.json();
}
```

### JavaScript 登錄示例
```javascript
async function login(username, password) {
    const response = await fetch('/api/user/login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            username: username,
            password: password
        })
    });
    const result = await response.json();
    if (result.success) {
        // 保存會話令牌
        localStorage.setItem('session_token', result.session_token);
        localStorage.setItem('user_id', result.user_id);
        localStorage.setItem('username', result.username);
    }
    return result;
}
```

### JavaScript 獲取用戶資料示例
```javascript
async function getUserProfile() {
    const sessionToken = localStorage.getItem('session_token');
    const response = await fetch(`/api/user/profile?session_token=${sessionToken}`);
    return await response.json();
}
```

## 安全說明

1. **密碼存儲**：所有密碼使用 SHA256 哈希存儲，不會存儲明文密碼
2. **會話管理**：使用安全的會話令牌，默認30天過期
3. **輸入驗證**：所有輸入都經過驗證和清理
4. **SQL注入防護**：使用參數化查詢，防止SQL注入攻擊

## 數據庫備份

建議定期備份數據庫文件：
```bash
cp database.db database.db.backup
```

## 故障排除

### 問題：數據庫文件權限錯誤
解決：確保數據庫文件有讀寫權限
```bash
chmod 644 database.db
```

### 問題：表不存在
解決：運行初始化腳本
```bash
python3 init_database.py
```

### 問題：連接失敗
解決：檢查數據庫文件是否存在，路徑是否正確

