# 前端數據庫集成說明

## 概述

前端已完全集成 SQLite 數據庫，所有用戶登錄、註冊和個人資料管理都通過後端 API 連接到數據庫。

## 已修改的文件

### 1. `user-api.js` (新建)
用戶 API 服務模組，提供所有與後端通信的函數：
- `register()` - 用戶註冊
- `login()` - 用戶登錄
- `logout()` - 用戶登出
- `getProfile()` - 獲取用戶資料
- `updateProfile()` - 更新用戶資料
- `getProgress()` - 獲取學習進度
- `updateProgress()` - 更新學習進度
- `checkUsername()` - 檢查用戶名
- `checkEmail()` - 檢查郵箱
- `validateSession()` - 驗證會話

### 2. `main.js`
已更新 `handleLogin()` 和 `handleRegister()` 函數：
- 使用 `UserAPI.login()` 替代 localStorage
- 使用 `UserAPI.register()` 替代 localStorage
- 添加加載狀態顯示
- 添加錯誤處理

### 3. `user-system.html`
已更新以下函數：
- `checkLoginStatus()` - 使用會話驗證
- `handleLogin()` - 調用後端 API
- `handleRegister()` - 調用後端 API
- `loadUserData()` - 從數據庫加載數據
- `saveUserData()` - 保存數據到數據庫

## 使用方式

### 在 HTML 頁面中引入

在任何需要使用登錄/註冊功能的頁面中，需要先加載 `user-api.js`：

```html
<script src="user-api.js"></script>
<script src="main.js"></script>
```

### 登錄流程

1. 用戶輸入用戶名和密碼
2. 前端調用 `UserAPI.login(username, password)`
3. 後端驗證用戶名和密碼（從 SQLite 數據庫）
4. 如果成功，返回會話令牌
5. 前端保存會話令牌到 localStorage
6. 用戶登錄成功

### 註冊流程

1. 用戶輸入用戶名、郵箱和密碼
2. 前端先檢查用戶名和郵箱是否已存在
3. 如果不存在，調用 `UserAPI.register(username, email, password)`
4. 後端在 SQLite 數據庫中創建新用戶
5. 自動創建用戶資料和學習進度記錄
6. 註冊成功，提示用戶登錄

### 數據加載流程

1. 頁面加載時調用 `checkLoginStatus()`
2. 檢查 localStorage 中是否有會話令牌
3. 如果有，驗證會話是否有效
4. 如果有效，從數據庫加載用戶資料和學習進度
5. 顯示用戶界面

### 數據保存流程

1. 用戶操作（完成練習、更新資料等）
2. 調用 `saveUserData()` 或 `UserAPI.updateProgress()`
3. 數據通過 API 保存到 SQLite 數據庫
4. 保存成功

## API 端點

所有 API 端點都在 `/api/user/` 路徑下：

- `POST /api/user/register` - 註冊
- `POST /api/user/login` - 登錄
- `POST /api/user/logout` - 登出
- `GET /api/user/profile` - 獲取資料
- `PUT /api/user/profile` - 更新資料
- `GET /api/user/progress` - 獲取進度
- `PUT /api/user/progress` - 更新進度
- `POST /api/user/check-username` - 檢查用戶名
- `POST /api/user/check-email` - 檢查郵箱
- `GET /api/user/session` - 驗證會話

## 會話管理

- 會話令牌存儲在 localStorage 中
- 會話有效期為 30 天
- 每次頁面加載時會驗證會話
- 會話無效時自動清除本地存儲

## 數據遷移

### 從 localStorage 遷移到數據庫

如果用戶之前使用 localStorage 存儲數據，可以：

1. 導出 localStorage 數據
2. 通過註冊 API 創建新用戶
3. 通過更新 API 導入舊數據

或者保持向後兼容，在數據庫中找不到數據時，從 localStorage 讀取（不推薦）。

## 錯誤處理

所有 API 調用都包含錯誤處理：
- 網絡錯誤：顯示"請檢查網絡連接"
- 驗證錯誤：顯示具體錯誤信息
- 服務器錯誤：顯示"服務器錯誤，請稍後再試"

## 測試

### 測試註冊
1. 打開用戶中心頁面
2. 點擊"註冊"
3. 輸入用戶名、郵箱和密碼
4. 提交註冊
5. 檢查數據庫中是否創建了新用戶

### 測試登錄
1. 使用註冊的帳號登錄
2. 檢查是否成功獲取會話令牌
3. 檢查用戶資料和進度是否正確加載

### 測試數據保存
1. 完成一個練習
2. 檢查數據是否保存到數據庫
3. 刷新頁面，檢查數據是否正確加載

## 注意事項

1. **後端服務必須運行**：所有 API 調用都需要後端服務運行在端口 5000
2. **數據庫必須初始化**：確保已運行 `init_database.py` 創建數據庫
3. **CORS 配置**：後端已配置 CORS，支持跨域請求
4. **會話安全**：會話令牌存儲在 localStorage，注意 XSS 攻擊防護

## 故障排除

### 問題：註冊/登錄失敗，顯示網絡錯誤
**解決**：
- 檢查後端服務是否運行：`python3 app.py`
- 檢查瀏覽器控制台是否有錯誤
- 檢查 API 端點是否正確

### 問題：會話驗證失敗
**解決**：
- 清除瀏覽器 localStorage
- 重新登錄
- 檢查數據庫中的會話表

### 問題：數據未保存
**解決**：
- 檢查瀏覽器控制台是否有錯誤
- 檢查後端日誌
- 確認數據庫權限正確

